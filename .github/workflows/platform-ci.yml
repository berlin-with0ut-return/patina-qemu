# A workflow to build the platform(s) in this repository using certain configurations.
#
##
# Copyright (c) Microsoft Corporation.
#
# SPDX-License-Identifier: BSD-2-Clause-Patent
##
name: "Platform CI"

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:

  # A job to produce the environment constants for this repository, so that the build job can
  # generate its matrix.
  vars:
    name: Get Repository Constants
    uses: ./.github/workflows/constants.yml

  # Builds the platform(s) in this repository as defined by the matrix.
  build:
    name: Build ${{ matrix.platform }} ${{ matrix.target }} ${{ matrix.tool-chain }}
    needs: vars
    runs-on: ${{ matrix.os }}

    # If matrix.container is not defined, then `image` will be null and no container will be used.
    container:
      image: ${{ matrix.container || null }}
      options: --security-opt seccomp=unconfined

    strategy:
      # This setting prevents the cancellation of other jobs when one job fails.
      fail-fast: false
      matrix:
        include:
          - config: 'Platforms/QemuQ35Pkg/PlatformBuild.py'
            target: 'DEBUG'
            tool-chain: ${{ needs.vars.outputs.windows-toolchain }}
            platform: 'Q35'
            os: 'windows-latest'
            readiness: true
          - config: 'Platforms/QemuQ35Pkg/PlatformBuild.py'
            target: 'RELEASE'
            tool-chain: ${{ needs.vars.outputs.windows-toolchain }}
            platform: 'Q35'
            os: 'windows-latest'
          - config: 'Platforms/QemuQ35Pkg/PlatformBuild.py'
            target: 'DEBUG'
            tool-chain: ${{ needs.vars.outputs.linux-toolchain }}
            platform: 'Q35'
            os: 'ubuntu-latest'
            container: ${{ needs.vars.outputs.container-image }}
          - config: 'Platforms/QemuQ35Pkg/PlatformBuild.py'
            target: 'RELEASE'
            tool-chain: ${{ needs.vars.outputs.linux-toolchain }}
            platform: 'Q35'
            os: 'ubuntu-latest'
            container: ${{ needs.vars.outputs.container-image }}
          - config: 'Platforms/QemuQ35Pkg/PlatformBuild.py'
            target: 'DEBUG'
            tool-chain: ${{ needs.vars.outputs.windows-toolchain }}
            architecture: 'IA32,X64'
            platform: 'Q35'
            os: 'windows-latest'
          - config: 'Platforms/QemuQ35Pkg/PlatformBuild.py'
            target: 'RELEASE'
            tool-chain: ${{ needs.vars.outputs.windows-toolchain }}
            architecture: 'IA32,X64'
            platform: 'Q35'
            os: 'windows-latest'
          - config: 'Platforms/QemuQ35Pkg/PlatformBuild.py'
            target: 'DEBUG'
            tool-chain: ${{ needs.vars.outputs.linux-toolchain }}
            architecture: 'IA32,X64'
            platform: 'Q35'
            os: 'ubuntu-latest'
            container: ${{ needs.vars.outputs.container-image }}
          - config: 'Platforms/QemuQ35Pkg/PlatformBuild.py'
            target: 'RELEASE'
            tool-chain: ${{ needs.vars.outputs.linux-toolchain }}
            architecture: 'IA32,X64'
            platform: 'Q35'
            os: 'ubuntu-latest'
            container: ${{ needs.vars.outputs.container-image }}
          - config: 'Platforms/QemuSbsaPkg/PlatformBuild.py'
            target: 'DEBUG'
            tool-chain: ${{ needs.vars.outputs.linux-toolchain }}
            platform: 'SBSA'
            os: 'ubuntu-latest'
            readiness: true
            container: ${{ needs.vars.outputs.container-image }}
          - config: 'Platforms/QemuSbsaPkg/PlatformBuild.py'
            target: 'RELEASE'
            tool-chain: ${{ needs.vars.outputs.linux-toolchain }}
            platform: 'SBSA'
            os: 'ubuntu-latest'
            container: ${{ needs.vars.outputs.container-image }}

    steps:
      # Checkout the repository to the runner or container
      - name: Checkout repository
        uses: actions/checkout@v6

      # Configure git for use in the container. Specifically needed for the FFA builds
      - name: Container Configuration
        if: ${{ matrix.container != null }}
        run: |
          git config --global --add safe.directory '*'
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # Set the version of Python to use when outside of a container. Otherwise just use what's
      # in the container.
      - name: Setup Python ${{ needs.vars.outputs.python-version }}
        if: ${{ matrix.container == null }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ needs.vars.outputs.python-version }}
          cache: 'pip'
          cache-dependency-path: 'pip-requirements.txt'
      
      # Install the pip dependencies needed to run stuart for the platform(s)
      - name: Install dependencies
        run: pip install -r pip-requirements.txt
      
      # Run the build-platform action, which calls stuart_setup, stuart_update, and stuart_build
      - name: Prepare and Build ${{ matrix.platform }} ${{ matrix.target }} ${{ matrix.tool-chain}} ${{ matrix.architecture || '' }}
        id: build-platform
        uses: ./.github/actions/build-platform
        with:
          command: 'build'
          platform-config: ${{ matrix.config }}
          platform-name: ${{ matrix.platform }}
          target: ${{ matrix.target }}
          tool-chain: ${{ matrix.tool-chain }}
          # Only pass architecture if it is defined in the matrix
          architecture: ${{ matrix.architecture || '' }}
          stuart-args: 'SHUTDOWN_AFTER_RUN=TRUE FILE_REGEX=*TestApp*.efi RUN_TESTS=TRUE QEMU_HEADLESS=TRUE BLD_*_QEMU_CORE_NUM=${{ needs.vars.outputs.qemu-core-count }}'

      - name: Run ${{ matrix.platform }} ${{ matrix.target }} ${{ matrix.tool-chain}} ${{ matrix.architecture || '' }}
        uses: ./.github/actions/build-platform
        with:
          command: 'flash'
          platform-config: ${{ matrix.config }}
          platform-name: ${{ matrix.platform }}
          target: ${{ matrix.target }}
          tool-chain: ${{ matrix.tool-chain }}
          # Only pass architecture if it is defined in the matrix
          architecture: ${{ matrix.architecture || '' }}
          stuart-args: 'SHUTDOWN_AFTER_RUN=TRUE FILE_REGEX=*TestApp*.efi RUN_TESTS=TRUE QEMU_HEADLESS=TRUE BLD_*_QEMU_CORE_NUM=${{ needs.vars.outputs.qemu-core-count }}'

      - name: Publish Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          # Specify architecture if it is not empty
          name: build-logs-${{ matrix.platform }}-${{ matrix.target }}-${{ matrix.tool-chain }}${{ matrix.architecture && format('-{0}', matrix.architecture) || '' }}
          path: ${{ steps.build-platform.outputs.log-path }}

  # Runs the readiness tool.
  readiness: 
    name: Build ${{ matrix.platform }} ${{ matrix.target }} ${{ matrix.tool-chain }}
    needs: vars
    runs-on: ${{ matrix.os }}
    container:
      image: ${{ matrix.container || null }}
    strategy:
      # This setting prevents the cancellation of other jobs when one job fails.
      fail-fast: false
      matrix:
        include:
          - config: 'Platforms/QemuQ35Pkg/PlatformBuild.py'
            target: 'DEBUG'
            tool-chain: 'VS2022'
            platform: 'Q35'
            os: 'windows-latest'
          - config: 'Platforms/QemuQ35Pkg/PlatformBuild.py'
            target: 'DEBUG'
            tool-chain: 'VS2022'
            architecture: 'IA32,X64'
            platform: 'Q35'
            os: 'windows-latest'
          - config: 'Platforms/QemuSbsaPkg/PlatformBuild.py'
            target: 'DEBUG'
            tool-chain: 'VS2022'
            platform: 'SBSA'
            os: 'ubuntu-latest'
            container: ${{ needs.vars.outputs.container-image }}

    steps:
      # Checkout the repository to the runner or container
      - name: Checkout repository
        uses: actions/checkout@v6

      # Configure git for use in the container. Specifically needed for the FFA builds
      - name: Container Configuration
        if: ${{ matrix.container != null }}
        run: |
          git config --global --add safe.directory '*'
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # Set the version of Python to use when outside of a container. Otherwise just use what's
      # in the container.
      - name: Setup Python ${{ needs.vars.outputs.python-version }}
        if: ${{ matrix.container == null }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ needs.vars.outputs.python-version }}
          cache: 'pip'
          cache-dependency-path: 'pip-requirements.txt'
      
      # Install the pip dependencies needed to run stuart for the platform(s)
      - name: Install dependencies
        run: pip install -r pip-requirements.txt
      
      # Build platform normally without readiness flags
      - name: Build platform (stuart_build)
        id: build-platform
        shell: bash
        run: |
          if [ "${{ inputs.platform }}" = "SBSA" ]; then
            override_value="QemuPkg/Binaries/READINESS.QEMU_extdep/capture/aarch64/qemu_dxe_readiness_capture.efi"
          elif [ "${{ inputs.platform }}" = "Q35" ]; then
            override_value="QemuPkg/Binaries/READINESS.QEMU_extdep/capture/x86_64/qemu_dxe_readiness_capture.efi"
          fi
          stuart_build -c ${{ inputs.platform-config }} ${{ steps.stuart.outputs.arguments }} BLD_*_DXE_CORE_BINARY_OVERRIDE="$override_value"

      # Run with readiness flags to capture output
      - name: Run and capture output (stuart_build)
        id: run-output
        shell: bash
        run: |      
          # dead loop runs forever, so timeout after logs are ready
          timeout 120s stuart_build -c ${{ inputs.platform-config }} --FlashOnly ${{ steps.stuart.outputs.arguments }} EMPTY_DRIVE=TRUE || [ $? -eq 124 ]

      # Extract json from build output
      - name: Extract JSON block from logfile
        shell: bash
        run: |
          if [ "${{ inputs.platform }}" = "SBSA" ]; then
            logfile="Build/BUILDLOG_QemuSbsaPkg_Run.txt"
          elif [ "${{ inputs.platform }}" = "Q35" ]; then
            logfile="Build/BUILDLOG_QemuQ35Pkg_Run.txt"
          fi

          capture_file="${{ steps.tempdir.outputs.path }}/capture.json"

          # Skip log lines and extract JSON content (from first { to last })
          sed -n '/^INFO - INFO - {$/,/^INFO - }$/{s/^INFO - //; s/^INFO - //; p}' "$logfile" > "$capture_file"
          
          # Verify JSON was extracted
          if [ -s "$capture_file" ] && grep -q '{' "$capture_file" && grep -q '}' "$capture_file"; then
            echo "Filtered JSON written to $capture_file"
          else
            echo "Error: No JSON block found in logfile" >&2
            exit 1
          fi

      # Optional: Move the build logs to the temporary directory if it was created
      - name: Move build log
        if: ${{ always() && steps.tempdir.outputs.path }}
        shell: bash
        env:
          TEMP_DIR: ${{ steps.tempdir.outputs.path }}
        run: |
          shopt -s globstar nullglob
          files=(**/BUILDLOG* **/BUILD_REPORT.TXT **/OVERRIDELOG.TXT)

          if ((${#files[@]})); then
            echo "Moving ${#files[@]} log files"
            mv "${files[@]}" "$TEMP_DIR"
          else
            echo "No matching log files found"
          fi


      - name: Run readiness validator
        shell: bash
        run: |
          capture_file="${{ steps.tempdir.outputs.path }}/capture.json"
          validator_log="${{ steps.tempdir.outputs.path }}/validator_output.txt"
          
          if [ "${{ inputs.platform }}" = "SBSA" ]; then
            chmod +x QemuPkg/Binaries/READINESS.QEMU_extdep/validator/linux/dxe_readiness_validator_x86_64
            ./QemuPkg/Binaries/READINESS.QEMU_extdep/validator/linux/dxe_readiness_validator_x86_64 -f "$capture_file" 2>&1 | tee "$validator_log"
          elif [ "${{ inputs.platform }}" = "Q35" ]; then
            ./QemuPkg/Binaries/READINESS.QEMU_extdep/validator/windows/dxe_readiness_validator_x86_64.exe -f "$capture_file" 2>&1 | tee "$validator_log"
          fi

      # Optional: Move the run logs to the temporary directory if it was created
      - name: Move run log
        if: ${{ always() && steps.tempdir.outputs.path }}
        shell: bash
        env:
          TEMP_DIR: ${{ steps.tempdir.outputs.path }}
        run: |
          shopt -s globstar nullglob
          files=(**/BUILDLOG_QemuQ35Pkg_Run.txt **/BUILDLOG_QemuSbsaPkg_Run.txt)

          if ((${#files[@]})); then
            echo "Moving ${#files[@]} log files"
            mv "${files[@]}" "$TEMP_DIR"
          else
            echo "No matching log files found"
          fi

      # Optional: Publish the logs as an artifact if the temporary directory was created
      - name: Publish Logs
        if: ${{ always() && steps.tempdir.outputs.path }}
        uses: actions/upload-artifact@v4
        with:
          # Specify architecture if it is not empty
          name: readiness-logs-${{ inputs.tool-chain }}-${{ inputs.platform && format('{0}-', inputs.platform) || '' }}${{ github.run_id }}
          path: ${{ steps.tempdir.outputs.path }}
          
  # A final job to indicate that all builds are complete. This allows the github required checks to
  # be targeted at a single job, instead of all the jobs in the matrix, which may change over time.
  finalize:
    name: Finalize CI

    runs-on: ubuntu-latest

    needs: build

    steps:
      - name: Finish
        run: echo "All builds complete"
