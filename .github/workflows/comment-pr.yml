
# @file comment-pr.yml
#
# GitHub Actions workflow to post comment(s) on PRs.
#
# This workflow runs access to secrets.
# It waits for the platform-ci.yml workflow to complete and posts the comment.
#
# Copyright (c) Microsoft Corporation.
# SPDX-License-Identifier: Apache-2.0

name: PR Comments

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Platform CI"]
    types:
      - completed

jobs:
  comment:
    name: Post PR Comment
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Download Q35 Readiness Report Data
        uses: actions/download-artifact@v4
        with:
          name: readiness-report-data-Q35
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Download SBSA Readiness Report Data
        uses: actions/download-artifact@v4
        with:
          name: readiness-report-data-SBSA
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: ðŸ“– Read PR Metadata
        id: pr-data
        shell: bash
        run: |
          echo "pr_number=$(cat pr_number.txt)" >> $GITHUB_OUTPUT
          echo "base_ref=$(cat base_ref.txt)" >> $GITHUB_OUTPUT
          echo "head_ref=$(cat head_ref.txt)" >> $GITHUB_OUTPUT

      # - name: Generate Token
      #   id: app-token
      #   uses: actions/create-github-app-token@v2
      #   with:
      #     app-id: ${{ secrets.PATINA_AUTOMATION_APPLICATION_ID }}
      #     private-key: ${{ secrets.PATINA_AUTOMATION_APPLICATION_PRIVATE_KEY }}
      #     owner: ${{ github.repository_owner }}

      - name: Set GITHUB_TOKEN for testing
        run: echo "TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV

      - name: Post Readiness Report as PR Comment
        env:
          # GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          PR_NUMBER: ${{ steps.pr-data.outputs.pr_number }}
        shell: bash
        run: |
          # Combine both platform reports
          echo "## Q35 Readiness Report" > combined_report.txt
          cat validator_output_Q35.txt >> combined_report.txt
          echo "" >> combined_report.txt
          echo "## SBSA Readiness Report" >> combined_report.txt
          cat validator_output_SBSA.txt >> combined_report.txt
          
          COMMENT_BODY=$(cat combined_report.txt)
          gh pr comment "$PR_NUMBER" \
            --repo ${{ github.repository }} \
            --body "$COMMENT_BODY" \
            --token $TOKEN
